---
title: "Environmental and Sociodemographic Determinants of Mortality in the US"
author: "Your Names Here"
date: "Add a date"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: "kate"
runtime: shiny
---

```{r setup, include = FALSE}
library(tidyverse)
library(kableExtra) # for example code; delete if not needed
#packages for text analysis shiny app 
library(tidyverse)
library(tidytext)
library(textdata)
library(ggnetwork)
library(igraph)
library(shiny)
library(dplyr)

# Set code chunk defaults 
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE,
                      fig.align = "center")

# Set R environment options
options(knitr.kable.NA = '')
```

# Introduction

In Louisiana, a row of toxic waste producing plants has gained national attention. In this area, large corporations continue to release larger and larger amounts of cancer-causing chemicals into the environment, and the effects on community health have been detrimental enough for this area to receive the name "Cancer Alley". The impacts of this unregulated pollution are not equally distributed: the groups at risk are predominantly black and low-income communities. Around the country, industries release fatal amounts of toxic chemicals into our environment, and underprivileged communities are most commonly the victims of these actions. The unequal distribution of wealth and power in our country, created by social systems that protect certain groups and leave others behind, has deep, historically established effects that extend even to the biological level. This is realized in the entangled relationship between sociodemographic inequality in the United States and toxicity in the environment. An individual's place within these imbricated factors is out of their control, and, yet, they can become major determinant's of an individual's health and wellbeing. 

[[CITE LITERATURE AND SPECIFIC INFORMATION ON THESE EFFECTS]]

## Questions


# Data

In order to analyze environmental and sociodemographic factors related to mortality rates, we used data from the Environmental Protection Agency (EPA) and the Center for Disease Control (CDC). [[ADD MORE HERE]]

In order to analyze research pertaining to mortality causes, we scraped abstracts from a PubMed search on 10/29/21. Search inputs included "mortality" AND "cause" OR "determinant", and we limited results to only the United States. We unnested individual words from the abstracts, and then we retained only words of interest (e.g. we removed words like "the", "results", or "mortality" which would not provide interesting information, see [[INSERT LINK]] for the full list of retained words).

# Results

<!-- could be interesting to start this section off with a simple but summative scatterplot (doesn't even have to be interactive) that shows overall relationship between mortality (response variable) and predictors of interest, including EQI, income, etc. (choose these based off of which factors are highlighted in our maps) -->

## Interactive map

## Relationships by county

## Research abstract analysis

```{r barchart-code, echo = TRUE, eval = FALSE}
#code to understand animation
```


![](data/gganim2.gif)

In the above animation, the top 10 words up until 2011 do not contain the word "social". In 2011, though, "social" enters the top ten words, and its ranking increases until 2021, when it is the most used word in research abstracts. 

```{r network-code, echo = TRUE, eval = FALSE}
#code to understand network
```


```{r network-display, out.extra='style="border: none;"', out.width='56%'}
# #embed shiny app once published
# knitr::include_url("https://eyzhang24.shinyapps.io/text_analysis/", height = "600px")
```

```{r network-display2, out.extra='style="border: none;"', out.width='56%'}
#read in list of abstracts
abstract_words <- read_csv("data/abstract_words.csv") 

#set seed and theme
set.seed(83426)
theme_set(theme_classic())

######
#data wrangling
######


empty <- data.frame(word = character())
keep_words <- empty %>%
  add_row(word = c("mortality", "disease", "age", "cancer", "women", "population", "hiv", "social",
                   "clinical", "children", "infection", "protein", "genetic", "blood",
                   "cardiovascular", "community", "diabetes", "heart", "exposure",
                   "gene", "national", "drug", "chronic", "physical", "virus",
                   "hospital", "sex", "smoking", "therapy", "interventions", "white",
                   "genes", "family", "race", "weight", "education", "alcohol",
                   "breast", "maternal", "antibodies", "lung", "income", "disparities",
                   "environmental", "obesity", "tumor", "region", "african", "stroke",
                   "cardiac", "viral", "hypertension", "immune", "respiratory", "hispanic",
                   "food", "infections", "dna", "infant", "gender", "socioeconomic",
                   "history", "coronary", "racial", "demographic", "mental", "male",
                   "underlying", "child", "infants", "poor", "ethnic", "rural",
                   "antibody", "pulmonary", "renal", "policy", "efforts", "female",
                   "sexual", "depression", "behavioral", "influenza", "economic", "genome",
                   "urban", "ethnicity"))

interest_words <- empty %>%
  add_row(word = c("mortality", "social", "disparities", "cancer", "community",
                   "genetic", "environmental", "family",
                   "racial", "demographic", "economic", "exposure")) %>% 
  mutate(category = NA)
interest_words$category[interest_words$word %in% c("mortality", "cancer")] <- "mortality"
interest_words$category[interest_words$word %in% c("social", "disparities", "racial", "demographic", 
                                    "economic")] <- "sociodemographic"
interest_words$category[interest_words$word %in% c("community", "family")] <- "contextual"
interest_words$category[interest_words$word %in% c("genetic")] <- "genetic"
interest_words$category[interest_words$word %in% c("environmental", "exposure")] <- "exposure"

shinyApp(
######
#ui
######

ui <- fluidPage(
  
  # tabPanel(
    titlePanel("Words used in research abstracts exploring causes of mortality"),

    sidebarLayout(
      sidebarPanel(
        sliderInput("year_b", "Year:",
                   min = 1985, max = 2021, sep= "",
                   value = 2006), 
        selectizeInput(inputId = "interest_list", 
                       label = "Select words to include:", 
                       choices = keep_words$word, 
                       selected = interest_words$word,
                       multiple = TRUE
        )
      ),
      mainPanel(plotOutput(outputId = "network"))
    # )
  )
), 

######
#server
######

server <- function(input, output) {
  
  #words of interest not found in year
  interest_missing <- reactive({
    present <- abstract_words %>% 
      filter(publication_year == input$year_b) 
    missing <- setdiff(as.list(input$interest_list), as.list(present$word))
    if(length(missing) > 0) {data <- paste(missing, collapse = ", ")}
    else {data <- "NA"}
  })
  
  #network
  output$network <- renderPlot({
    set.seed(83426)
    #choose interest words from year
    network_words <- abstract_words %>% 
      filter(publication_year == input$year_b) %>% 
      filter(word %in% input$interest_list) %>% 
      count(word, sort = TRUE) %>%  #get counts of words  
      left_join(interest_words, by = "word")
    #create dataframe
    df <- abstract_words %>%
      filter(publication_year == input$year_b) %>% 
      right_join(network_words, by = "word") %>% #only keeps interest words
      unique() %>% #remove repeats of connections in same abstract
        select(pmid, word) %>%
        table() %>%
        crossprod() #creates co-occurence matrix
    diag(df) <- 0 #sets connections between same word to 0
    df <- as.data.frame(df) 
    
    num_word <- ncol(df) 

    #define vertices and edges
    ve <- network_words 
    ed <- df %>%
      mutate(from = rownames(.)) %>%
      tidyr::gather(to, weight, 1:num_word) %>% #gathers co-instances from matrix
      mutate(weight = ifelse(weight == 0, NA, weight))

    #create igraph
    abst_igraph <- graph_from_data_frame(d = ed,
                                         vertices = ve,
                                         directed = FALSE) %>%
      simplify() #remove duplicate edges

    #plot network
    abst_network <- ggnetwork(abst_igraph)
    ggplot(data = abst_network, aes(x = x, y = y,
                                   xend = xend, yend = yend)) +
      geom_edges(aes(size = weight), 
                    color = "lightgray", curvature = .1) +
      geom_nodes(aes(size = n, color = category), shape = 20)  +
      geom_nodetext_repel(aes(label = name, size = n), repel = TRUE, 
                    point.padding = unit(0.2, "lines"), color = "gray10") +
      colorspace::scale_color_discrete_qualitative(palette = "Dark 3") +
      guides(size = guide_legend(order = 2), color = guide_legend(order = 1)) +
      ggraph::scale_edge_width(c(0.5, 5)) +
      # geom_nodes() +
      # geom_nodelabel(aes(label = name, size = n), nudge_x = .01) +
      theme_blank() +
      labs(size = "Number", color = "Category", 
           caption = paste("Words not found: ", interest_missing(), 
                           "\n Data source: PubMed, years before 1985 ommitted due to insufficient data"))

  })
}, 
options = list(height = 600)
)

```

In the above network, sociodemographic factors tend to be on the edge of the network in earlier years, and the networks tend to be more disconnected. As the years progress, though, at around 2010-2013, the network tend to become much more connected. From 2013-2021, sociodemographic factors also tend to become more and more central to the network. 

# Conclusion

## Limitations and Future Directions

Our findings on the focus of research over time is promising. The rise in the consideration of social factors and their connection to mortality shows increased acknowledgement of the inequality of mortality risks. However, the gap between research and policy is often wide and difficult to bridge. Progressive findings in scientific abstracts, while representative of the inclusion of social thought into clinical work, are not an accurate measure of whether tangible change is being generated from these conclusions. Through lobbying, corporations have a much larger influence in restricting the passage of policies that may reduce their profits than in research (though the influence on scientific research is still present, through funding sources). To assess whether policy makers are putting forth legislation that addresses the root sociodemographic causes of unequal mortality risk, and whether that inequality is even acknowledged in the first place, we would like to  extend our project in the future by analyzing legislation that is proposed/passed in regards to environmental toxicity and mortality. This can allow us to understand whether there is a lag between research and legislation and to explore how the government is addressing these issues. 

# References

<!-- beginning of template -->

# Header 1 (Section heading)

## Header 2 (Subsection heading)

### Header 3 (Subsubsection heading)

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For example, you can include **Bold** and _Italic_ and `Code` text.  For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

You should test out updating your GitHub Pages website:

* clone your group's blog project repo in RStudio
* update "Your Project Title Here" to a new title in the YAML header
* knit `index.Rmd` (we will now knit to HTML by default instead of pdf)
* commit and push **both** `index.Rmd` and `index.html`
* go to https://stat231-f21.github.io/blog_five-chives/ to see the published test document (this is publicly available!)

## Including code and plots

You can embed code as normal, for example:

```{r cars}
summary(cars)
```

Let's clean up the format of that output instead of using the standard R output:

```{r pretty-table, echo = TRUE}
summary(cars) %>%
  kable(col.names = c("Speed", "Distance"),
        row.names = FALSE) %>%
  kable_styling(bootstrap_options = "striped",
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1:2, width = "1.5in") 
```

In a study from the 1920s, fifty cars were used to see how the speed of the car and the distance taken to stop were related.  Speeds ranged between `r min(cars$speed)` and `r max(cars$speed)` mph.  Distances taken to stop ranged between `r min(cars$dist)` and `r max(cars$dist)` feet, with the middle 50% falling between `r as.numeric(quantile(cars$dist)[2])` and `r as.numeric(quantile(cars$dist)[4])` feet.  

You can also embed plots as normal, for example:

```{r figure1}
ggplot(data = cars, aes(x = speed, y = dist)) + 
  geom_point() + 
  labs(x = "Speed of car (mph)",
       y = "Distance taken to stop (ft)",
       title = "Stopping distance increases with faster speeds",
       subtitle = "Based on 1920s study") +
  theme_classic()
```

Take note of the default code chunk options in the `setup` code chunk, and adjust individual code chunk options as needed. for example, unlike the rest of the Rmd files we worked in this semester, the default code chunk option is `echo = FALSE`, so you will need to set `echo  = TRUE` for any code chunks you would like to display in the blog. 


## Including links and images/videos

You can include [links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and there are a few ways to embed  images! Both options for embedding images below can be used interchangeably. They both work for png, pdf, jpg, and even gif formats, and both support filepaths that are either URLs (for videos, you can include links to any valid YouTube or Vimeo URLs; see [here](https://bookdown.org/yihui/rmarkdown/learnr-videos.html) for more details) or point to a location within your project directory. 

### Option 1: Markdown approach

![This is a figure caption. The artwork is called Safe Space by  [Kenesha Sneed](https://www.keneshasneed.com/#/safespace/)](img/Kenesha-Sneed_safe-space.jpeg)


### Option 2: Code chunk approach

```{r, fig.cap = "This is also figure caption"}
knitr::include_graphics("https://media.giphy.com/media/H7ZrrA9V2pd3Tehdds/giphy.gif")
```

## Including equations

Equations may be needed if you are explaining a new technique or perhaps providing some other relevant formulas in your exposition. There are two ways to include equations:

* Inline: $b \sim N(0, \sigma^2_b)$
* Display-style (displayed on its own line): $$\frac{\sigma^2_b}{\sigma^2_b + \sigma^2_e}$$

For typesetting equations appropriately, take a look at the *Symbols in math mode* section of this  [cheat sheet](https://users.dickinson.edu/~richesod/latex/latexcheatsheet.pdf)  (or do some extra Googling---there are *many* resources).


# You can even create tabs within your webpage if you want! {.tabset .tabset-fade .tabset-pills}

Every subsection heading (starting with `##`) until you create a new section heading (starting with `#`) will be a new tab.

## Bulleted list

You can make a bulleted list like this:

* item 1
* item 2
* item 3


## Numbered list

You can make a numbered list like this

1. First thing I want to say
2. Second thing I want to say
3. Third thing I want to say

# Customizing your blog design

As a *final* detail **only** if you have time, you can explore options for customizing the style of your blog. By default, we are using the `readthedown` theme from the [**rmdformats** package](https://github.com/juba/rmdformats) (see Line 6 of this file if you want to switch out themes). There are, I'm sure, many many many more similar packages with built in themes, or you can look into how to include a CSS code chunk to customize aspects of the current theme.  

There are some easy-to-change options that you can play around with:

* The theme itself (Line 6): `rmdformats::readthedown`, `rmdformats::downcute`, `rmdformats::robobook`, `rmdformats::material`,
  * For `downcute` only, you can add a new indented line below Line 6 with the code `downcute_theme: "chaos"` for the `downcute chaos` theme
  * I would *not* recommend the other themes that do not have the sidebar navigation
  
* Syntax highlighting options (Line 8, `highlight`): `"default"`, `"tango"`, `"pygments"`, `"kate"`, `"monochrome"`, `"espresso"`, `"zenburn"`, `"haddock"`, or `"textmate"` (or `NULL` for no syntax highlighting)


You can explore additional customizable YAML options by looking at the [**rmdformats** package](https://github.com/juba/rmdformats) page or running, for example, `?rmdformats::readthedown()` to see the help documentation for a particular theme from the package.
